# encoding: tarantool
#
import yaml
def print_usage():
  info = yaml.load(admin.execute("show info\n"))["info"]
  print "usage = " + str(info["namespace_stat"]["namespace_0"]["usage"])

print """
#
# Test cases for: https://blueprints.launchpad.net/tarantool/+spec/namespace-limits
# Limit the total amount of memory consumed by a namespace
# 
"""
# cleanup
server.stop()
server.deploy("box_big/tarantool_namespace_limit.cfg")

print """
#
# check namespace limit
#  insert several tuples
#
"""
for i in range(10):
  exec sql "insert into t0 values ({0}, 'tuple')".format(i)
print_usage()
print """
#
#  free some space in namespace
#
"""
exec sql "delete from t0 where k0 = 0"
exec sql "delete from t0 where k0 = 1"
exec sql "delete from t0 where k0 = 2"
print_usage()
exec sql "insert into t0 values (8, 'tuple')"
exec sql "insert into t0 values (9, 'tuple')"
print_usage()

print """
#
#  try to decrease namespace limit in runtime
#
"""
server.reconfigure("box_big/tarantool_namespace_limit_bad.cfg")

# TODO: try to restart server with lower namespace limit

print """
#
#  try to increase namespace limit in runtime
#
"""
server.reconfigure("box_big/tarantool_namespace_limit_good.cfg")
print """
#
#  check that limit is changed: insert a lot of tuples
#
"""
for i in range(10, 20):
  exec sql "insert into t0 values ({0}, 'tuple')".format(i)
print_usage()

# restore default server
server.stop()
server.deploy(self.suite_ini["config"])
# vim: syntax=python
